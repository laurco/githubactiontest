name: CI & Build

on:
  push:
    branches: [ main ]

jobs:
  # === JOB 1: CHECKOUT + UPLOAD CODE ===
  ci-checkout:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Upload source code
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: .
          retention-days: 1

  # === JOB 2: SETUP PYTHON ===
  ci-setup-python:
    needs: ci-checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

  # === JOB 3: INSTALL DEPS ===
  ci-install-deps:
    needs: ci-setup-python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Create requirements.txt
        run: |
          cat > requirements.txt << EOF
          Flask==3.0.3
          pytest==8.3.3
          PyInstaller==6.10.0
          EOF
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

  # === JOB 4: RUN TESTS ===
  ci-run-tests:
    needs: ci-install-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Run Tests
        id: tests
        continue-on-error: true
        run: pytest test_app.py -v || echo "Tests failed or not found"

  # === JOB 5: ARCHIVE & UPLOAD CI RESULTS ===
  ci-archive-upload:
    needs: ci-run-tests
    runs-on: ubuntu-latest
    outputs:
      download_url: ${{ steps.artifact.outputs.download_url }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Archive CI Results
        run: zip -r ci-results-${{ github.run_number }}.zip . -x "*.git*"
      - name: Upload CI Artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ci-results-${{ github.run_number }}
          path: ci-results-${{ github.run_number }}.zip
      - name: Get Artifact Download URL
        id: artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          URL="https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/artifacts"
          DOWNLOAD_URL=$(curl -s -H "Authorization: token $GH_TOKEN" "$URL" | jq -r '.artifacts[] | select(.name == "ci-results-${{ github.run_number }}") | .archive_download_url')
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

  # === JOB 6: BUILD BINARY ===
  build-binary:
    needs: ci-archive-upload
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Build Binary
        run: |
          pip install pyinstaller
          pyinstaller --onefile --name FlaskApp-Linux app.py
          chmod +x dist/FlaskApp-Linux
          zip FlaskApp-Linux-${{ github.run_number }}.zip dist/FlaskApp-Linux
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: FlaskApp-Linux-${{ github.run_number }}
          path: FlaskApp-Linux-${{ github.run_number }}.zip
      - name: Get Binary Download URL
        id: artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: |
          URL="https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/artifacts"
          DOWNLOAD_URL=$(curl -s -H "Authorization: token $GH_TOKEN" "$URL" | jq -r '.artifacts[] | select(.name == "FlaskApp-Linux-${{ github.run_number }}") | .archive_download_url')
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT