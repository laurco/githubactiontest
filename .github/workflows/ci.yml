name: CI Flask App - Max Notify

on:
  push:
    branches: [ main ]

env:
  HUB_WEBHOOK_URL: ${{ secrets.HUB_WEBHOOK_URL }}
  REPO: ${{ github.repository }}
  REF: ${{ github.ref }}

jobs:
  start-notify:
    runs-on: ubuntu-latest
    outputs:
      start_time: ${{ steps.timestamp.outputs.time }}
    steps:
      - name: Log environment variables
        run: |
          echo "::group::[DEBUG] Environment variables"
          echo "REPO=${{ github.repository }}"
          echo "REF=${{ github.ref }}"
          echo "RUN_ID=${{ github.run_id }}"
          echo "Webhook URL is set? ${{ env.HUB_WEBHOOK_URL != '' }}"
          echo "::endgroup::"

        - name: Get start timestamp
          id: timestamp
          run: echo "time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

        - name: Notify pipeline start
          if: env.HUB_WEBHOOK_URL != ''
          run: |
            curl -s -X POST "$HUB_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$(jq -n \
                --arg repo "${{ env.REPO }}" \
                --arg ref "${{ env.REF }}" \
                --arg date "${{ steps.timestamp.outputs.time }}" \
                '{type:"start", repo:$repo, branch:$ref, start_time:$date}')"

  main:
    needs: start-notify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest test_app.py -v
      - name: Archive results
        run: zip -r results.zip .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-results
          path: results.zip

  fail-notify:
    if: failure()
    needs: [start-notify, main]
    runs-on: ubuntu-latest
    steps:
      - name: Notify failure
        run: |
          curl -s -X POST "$HUB_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg repo "${{ env.REPO }}" \
              --arg ref "${{ env.REF }}" \
              --arg date "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
              --arg step "${{ github.job }}" \
              '{type:"fail", repo:$repo, branch:$ref, failed_step:$step, fail_time:$date}')"

  end-notify:
    if: always()
    needs: [start-notify, main]
    runs-on: ubuntu-latest
    steps:
      - name: Get end timestamp
        id: timestamp
        run: echo "time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Notify pipeline end
        if: env.HUB_WEBHOOK_URL != ''
        run: |
          ARTIFACT_URL="https://github.com/${{ env.REPO }}/actions/runs/${{ github.run_id }}"
          curl -s -X POST "$HUB_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg repo "${{ env.REPO }}" \
              --arg ref "${{ env.REF }}" \
              --arg date "${{ steps.timestamp.outputs.time }}" \
              --arg url "$ARTIFACT_URL" \
              '{type:"end", repo:$repo, branch:$ref, end_time:$date, artifact_url:$url}')"
