name: CI Flask App - Jobs Séparés (SANS CONFLIT)

on:
  push:
    branches: [ main ]

env:
  REPO: ${{ github.repository }}
  REF: ${{ github.ref }}
  COMMIT: ${{ github.sha }}
  WEBHOOK_URL: https://karri-fruity-wrongfully.ngrok-free.dev/webhook
  NGROK_SECRET: ${{ secrets.DEPLOY_ROBOT_SECRET }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # === JOB 1: CHECKOUT + UPLOAD CODE ===
  ci-checkout:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Upload source code
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: .
          retention-days: 1

  # === JOB 2: SETUP PYTHON ===
  ci-setup-python:
    needs: ci-checkout
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

  # === JOB 3: INSTALL DEPS ===
  ci-install-deps:
    needs: ci-setup-python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Create requirements.txt
        run: |
          cat > requirements.txt << EOF
          Flask==3.0.3
          pytest==8.3.3
          PyInstaller==6.10.0
          EOF
      - name: Notify Start - Install deps
        run: |
          START_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          PAYLOAD=$(jq -n \
            --arg repo "$REPO" --arg ref "$REF" --arg commit "$COMMIT" \
            --arg step "Install deps" --arg status "START" --arg start_time "$START_TIME" \
            '{type:"step", repo:$repo, branch:$ref, commit:$commit, step:$step, status:$status, start_time:$start_time}')
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$NGROK_SECRET" | awk '{print $2}')
          curl -s -X POST "$WEBHOOK_URL" -H "Content-Type: application/json" \
            -H "X-Ngrok-Hmac-Signature: $SIGNATURE" -d "$PAYLOAD"
      - name: Install Dependencies
        id: install
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      - name: Notify End - Install deps
        if: always()

  # === JOB 4: RUN TESTS ===
  ci-run-tests:
    needs: ci-install-deps
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Notify Start - Run Tests
        run: |
          START_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          PAYLOAD=$(jq -n \
            --arg repo "$REPO" --arg ref "$REF" --arg commit "$COMMIT" \
            --arg step "Run Tests" --arg status "START" --arg start_time "$START_TIME" \
            '{type:"step", repo:$repo, branch:$ref, commit:$commit, step:$step, status:$status, start_time:$start_time}')
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$NGROK_SECRET" | awk '{print $2}')
          curl -s -X POST "$WEBHOOK_URL" -H "Content-Type: application/json" \
            -H "X-Ngrok-Hmac-Signature: $SIGNATURE" -d "$PAYLOAD"
      - name: Run Tests
        id: tests
        continue-on-error: true
        run: pytest test_app.py -v || echo "Tests failed or not found"
      - name: Notify End - Run Tests
        if: always()

  # === JOB 5: ARCHIVE & UPLOAD CI RESULTS ===
  ci-archive-upload:
    needs: ci-run-tests
    runs-on: ubuntu-latest
    outputs:
      download_url: ${{ steps.artifact.outputs.download_url }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      - name: Archive CI Results
        run: zip -r ci-results-${{ github.run_number }}.zip . -x "*.git*"
      - name: Upload CI Artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ci-results-${{ github.run_number }}
          path: ci-results-${{ github.run_number }}.zip
      - name: Get Artifact Download URL
        id: artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
      

  # === JOB 6: NOTIFY PIPELINE END ===
  ci-notify-end:
    needs: ci-archive-upload
    runs-on: ubuntu-latest
    steps:
      - name: Notify Pipeline Start
        run: |
          START_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          PAYLOAD=$(jq -n --arg repo "$REPO" --arg ref "$REF" --arg commit "$COMMIT" \
            --arg status "START" --arg start_time "$START_TIME" \
            '{type:"pipeline", repo:$repo, branch:$ref, commit:$commit, status:$status, start_time:$start_time}')
          SIGNATURE=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$NGROK_SECRET" | awk '{print $2}')
          curl -s -X POST "$WEBHOOK_URL" -H "Content-Type: application/json" \
            -H "X-Ngrok-Hmac-Signature: $SIGNATURE" -d "$PAYLOAD"
      - name: Notify Pipeline End
        if: always()
        env:
          ARTIFACT_URL: ${{ needs.ci-archive-upload.outputs.download_url }}

  # === JOB 7: BUILD BINARY ===
  build-binary:
    needs: ci-notify-end
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .
      
      - name: Build Binary
        run: |
          pip install pyinstaller
          pyinstaller --onefile --name FlaskApp-Linux app.py
          chmod +x dist/FlaskApp-Linux
          zip FlaskApp-Linux-${{ github.run_number }}.zip dist/FlaskApp-Linux
      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: FlaskApp-Linux-${{ github.run_number }}
          path: FlaskApp-Linux-${{ github.run_number }}.zip
      - name: Get Artifact Download URL
        id: artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
     
      - name: Notify End - Build Binary
        env:
          WEBHOOK_URL: ${{ env.WEBHOOK_URL }}
          NGROK_SECRET: ${{ secrets.DEPLOY_ROBOT_SECRET }}
          DOWNLOAD_URL: ${{ steps.artifact.outputs.download_url }}
    